<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificación de Promotores</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        .container {
            transition: all 0.3s ease-in-out;
        }
        .photo-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-2 sm:p-4 md:p-8">
    <!-- Botón de información flotante -->
    <div class="fixed top-4 right-4 z-50 no-print">
        <button id="info-btn" class="p-2 bg-gray-700 text-gray-300 rounded-full hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>

    <!-- Modal de información (oculto por defecto) -->
    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 hidden">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 w-11/12 max-w-sm relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h3 class="text-xl font-bold text-gray-200 mb-4 text-center">Información</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-bold text-sm text-gray-300 mb-1">ID de Usuario:</h4>
                    <p id="user-id" class="text-xs text-gray-400 break-words">Autenticando...</p>
                </div>
                <hr class="border-gray-600">
                <div>
                    <h4 class="font-bold text-sm text-gray-300 mb-1">Creador:</h4>
                    <p class="text-xs text-gray-400">Francisco Rosales</p>
                    <p class="text-xs text-gray-400">Personal Unity Studio</p>
                    <p class="text-xs text-gray-400">franciswco8@gmail.com</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de mensaje de estado (visible por defecto) -->
    <div id="status-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 hidden">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 w-11/12 max-w-sm relative text-center">
            <p id="status-modal-message" class="text-lg text-gray-200 mb-4"></p>
            <button id="status-modal-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                Aceptar
            </button>
        </div>
    </div>

    <div id="app-container" class="container w-full max-w-4xl bg-gray-800 rounded-3xl shadow-2xl p-4 sm:p-6 md:p-10 border border-gray-700 relative">
        <!-- Contenedor de la vista del Promotor -->
        <div id="promotor-view" class="active">
            <div class="text-center mb-6 sm:mb-8">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-400 mb-2">
                    Planificación Semanal
                </h1>
                <p class="text-lg sm:text-xl text-gray-400 font-light">
                    Actividades de Promotores
                </p>
            </div>

            <!-- Formulario de inicio de sesión -->
            <div id="auth-container" class="mb-6 bg-gray-700 p-4 sm:p-6 rounded-xl shadow-inner no-print">
                <h2 id="auth-title" class="text-xl sm:text-2xl font-bold text-gray-200 mb-4 text-center">
                    Iniciar sesión
                </h2>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-gray-300 font-medium mb-1">Correo Electrónico</label>
                        <input type="email" id="auth-email" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="tu-correo@ejemplo.com" required />
                    </div>
                    <div>
                        <label for="auth-password" class="block text-gray-300 font-medium mb-1">Contraseña</label>
                        <input type="password" id="auth-password" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                    </div>
                    <button type="submit" id="auth-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-700">
                        Iniciar Sesión
                    </button>
                    <button type="button" id="toggle-auth-btn" class="w-full text-blue-400 hover:text-blue-300 font-medium mt-2">
                        ¿No tienes una cuenta? Crea una.
                    </button>
                </form>
            </div>

            <!-- Botón de cerrar sesión -->
            <div id="sign-out-container" class="mb-6 flex justify-center hidden no-print">
                <button id="sign-out-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-700">
                    Cerrar Sesión
                </button>
            </div>

            <!-- Información del promotor -->
            <div id="promotor-data-container" class="hidden">
                <div class="mb-6 bg-gray-700 p-4 rounded-xl no-print">
                    <label for="promotor-name" class="block text-gray-300 font-medium mb-2">
                        Nombre del Promotor
                    </label>
                    <input
                        type="text"
                        id="promotor-name"
                        class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Promotor"
                        required
                    />
                </div>
                
                <h3 class="text-xl sm:text-2xl font-bold text-gray-200 mb-4 text-center print-only">
                    Promotor: <span id="promotor-name-print"></span>
                </h3>


                <!-- Formulario de nueva actividad -->
                <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-inner mb-6 no-print">
                    <h2 id="form-title" class="text-xl sm:text-2xl font-bold text-gray-200 mb-4">
                        Nueva Actividad
                    </h2>
                    <!-- Cambiado a una cuadrícula de una columna en móviles y dos en pantallas más grandes para mejor responsividad -->
                    <form id="activity-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="sector" class="block text-gray-300 font-medium mb-1">Sector / Comuna / C.C.</label>
                            <input type="text" id="sector" name="sector" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Sector Tequendama" required />
                        </div>
                        <div class="col-span-1">
                            <label for="vocero_contacto" class="block text-gray-300 font-medium mb-1">Vocero Contacto</label>
                            <input type="text" id="vocero_contacto" name="vocero_contacto" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Juan Pérez" required />
                        </div>
                        <div class="col-span-1">
                            <label for="cedula_vocero" class="block text-gray-300 font-medium mb-1">Cédula Vocero</label>
                            <input type="text" id="cedula_vocero" name="cedula_vocero" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: V-12345678" />
                        </div>
                        <div class="col-span-1">
                            <label for="telefono" class="block text-gray-300 font-medium mb-1">Teléfono</label>
                            <input type="tel" id="telefono" name="telefono" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 0412-1234567" />
                        </div>
                        <div class="col-span-1">
                            <label for="voceria" class="block text-gray-300 font-medium mb-1">Vocería</label>
                            <input type="text" id="voceria" name="voceria" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Salud" />
                        </div>
                        <div class="col-span-1">
                            <label for="actividad" class="block text-gray-300 font-medium mb-1">Actividad</label>
                            <input type="text" id="actividad" name="actividad" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Asesoría sobre uso de VenApp" required />
                        </div>
                        <div class="col-span-1">
                            <label for="dia" class="block text-gray-300 font-medium mb-1">Día</label>
                            <select id="dia" name="dia" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option>Lunes</option>
                                <option>Martes</option>
                                <option>Miércoles</option>
                                <option>Jueves</option>
                                <option>Viernes</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="fecha" class="block text-gray-300 font-medium mb-1">Fecha</label>
                            <input type="date" id="fecha" name="fecha" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        </div>
                        <div class="col-span-1">
                            <label for="hora" class="block text-gray-300 font-medium mb-1">Hora</label>
                            <input type="time" id="hora" name="hora" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <button type="submit" id="form-button" class="col-span-1 sm:col-span-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-700">
                            Agregar Actividad
                        </button>
                    </form>
                </div>

                <!-- Lista de actividades -->
                <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-inner mb-6 activities-list-container">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-200 mb-4 print-only">
                        Planificación Actual
                    </h2>
                    <div id="activities-list" class="space-y-4">
                        <p class="text-center text-gray-400">No hay actividades planificadas.</p>
                    </div>
                </div>

                <!-- Sección de fotos -->
                <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-inner mb-6 no-print">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-200 mb-4">
                        Subir Fotos del Trabajo
                    </h2>
                    <div class="mb-4">
                        <label for="photo-date" class="block text-gray-300 font-medium mb-1">Fecha del trabajo</label>
                        <input type="date" id="photo-date" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                    </div>
                    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                        <input type="file" id="photo-upload-input" multiple accept="image/*" class="w-full text-white bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <button id="upload-photos-btn" class="w-full sm:w-auto bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                            Subir
                        </button>
                    </div>
                    <!-- Asegura que las miniaturas de las fotos se ajusten a la pantalla -->
                    <div id="photo-previews" class="flex flex-wrap gap-4 justify-center sm:justify-start">
                        <!-- Las miniaturas de las fotos se renderizarán aquí -->
                    </div>
                </div>

                <!-- Botones de guardar y ver -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4 no-print">
                    <button id="save-schedule-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-700">
                        Guardar Planificación Semanal
                    </button>
                    <button id="show-liaison-view-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-700">
                        Ver como Jefe de Enlace
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenedor de la vista del Jefe de Enlace -->
        <div id="liaison-view" class="hidden">
            <div class="text-center mb-6 sm:mb-8 no-print">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-purple-400 mb-2">
                    Visor de Planificaciones
                </h1>
                <p class="text-lg sm:text-xl text-gray-400 font-light">
                    Explora las planificaciones de todos los promotores.
                </p>
            </div>

            <!-- Lista de promotores -->
            <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-200 mb-4">
                    Promotores y sus Planificaciones
                </h2>
                <div id="liaison-list" class="space-y-4">
                    <p class="text-center text-gray-400">Cargando datos de promotores...</p>
                </div>
            </div>

            <!-- Botón para regresar -->
            <button id="show-promotor-view-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-700">
                    Volver a mi Planificación
                </button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importar las bibliotecas de Firebase
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro en debug para una mejor visibilidad
        setLogLevel('debug');

        // Global variables from the canvas environment
        const appId = "1:204805744165:web:1b0697ee57698d0d6801cc";
        
        // ¡¡¡IMPORTANTE!!! Reemplaza la siguiente constante con la configuración de tu propio proyecto de Firebase.
        // Puedes encontrarla en la "Configuración del proyecto" > "Tus aplicaciones" > "Config".
        const firebaseConfig = {
            apiKey: "AIzaSyD8wcFSbcQT0BV7fTj2820A2DOcBqAw-zI",
            authDomain: "planificador-de-promotores.firebaseapp.com",
            projectId: "planificador-de-promotores",
            storageBucket: "planificador-de-promotores.firebasestorage.app",
            messagingSenderId: "204805744165",
            appId: "1:204805744165:web:1b0697ee57698d0d6801cc"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;

        // DOM elements
        const promotorView = document.getElementById('promotor-view');
        const liaisonView = document.getElementById('liaison-view');
        const showLiaisonViewBtn = document.getElementById('show-liaison-view-btn');
        const showPromotorViewBtn = document.getElementById('show-promotor-view-btn');
        const promotorNameInput = document.getElementById('promotor-name');
        const promotorNamePrint = document.getElementById('promotor-name-print');
        const activityForm = document.getElementById('activity-form');
        const activitiesList = document.getElementById('activities-list');
        const saveScheduleBtn = document.getElementById('save-schedule-btn');
        const liaisonList = document.getElementById('liaison-list');
        const formTitle = document.getElementById('form-title');
        const formButton = document.getElementById('form-button');
        const statusModal = document.getElementById('status-modal');
        const statusModalMessage = document.getElementById('status-modal-message');
        const statusModalCloseBtn = document.getElementById('status-modal-close-btn');
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleAuthBtn = document.getElementById('toggle-auth-btn');
        const signOutContainer = document.getElementById('sign-out-container');
        const signOutBtn = document.getElementById('sign-out-btn');
        const promotorDataContainer = document.getElementById('promotor-data-container');
        const photoUploadInput = document.getElementById('photo-upload-input');
        const uploadPhotosBtn = document.getElementById('upload-photos-btn');
        const photoPreviewsContainer = document.getElementById('photo-previews');
        const photoDateInput = document.getElementById('photo-date');
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const userIdEl = document.getElementById('user-id');
        
        // Estado local de la aplicación
        let activities = [];
        let photos = [];
        let editingIndex = null;
        let isAuthReady = false;
        let isSigningUp = false;

        // --- Funciones de Utilidad ---
        function showTemporaryStatus(message) {
            statusModalMessage.textContent = message;
            statusModal.classList.remove('hidden');
        }

        statusModalCloseBtn.addEventListener('click', () => {
            statusModal.classList.add('hidden');
        });

        // --- Lógica de la interfaz de usuario ---
        function renderActivities() {
            activitiesList.innerHTML = '';
            if (activities.length === 0) {
                activitiesList.innerHTML = '<p class="text-center text-gray-400">No hay actividades planificadas.</p>';
            } else {
                activities.forEach((activity, index) => {
                    const activityEl = document.createElement('li');
                    activityEl.className = 'bg-gray-800 p-4 rounded-lg shadow-md border border-gray-600 activity-item';
                    activityEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2 no-print">
                            <span class="text-lg font-bold text-blue-300">${activity.dia} - ${activity.fecha}</span>
                            <div class="space-x-2">
                                <button class="edit-btn p-2 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white transition-colors duration-200" title="Editar" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                </button>
                                <button class="delete-btn p-2 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors duration-200" title="Eliminar" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-400">
                            <span class="font-semibold text-gray-300 print-only">Día:</span> ${activity.dia}<br/>
                            <span class="font-semibold text-gray-300">Sector / Comuna / C.C.:</span> ${activity.sector}<br/>
                            <span class="font-semibold text-gray-300">Vocero Contacto:</span> ${activity.vocero_contacto}<br/>
                            <span class="font-semibold text-gray-300">Cédula Vocero:</span> ${activity.cedula_vocero || 'No especificada'}<br/>
                            <span class="font-semibold text-gray-300">Teléfono:</span> ${activity.telefono || 'No especificado'}<br/>
                            <span class="font-semibold text-gray-300">Vocería:</span> ${activity.voceria || 'No especificada'}<br/>
                            <span class="font-semibold text-gray-300">Actividad:</span> ${activity.actividad}<br/>
                            <span class="font-semibold text-gray-300">Hora:</span> ${activity.hora || 'No especificada'}
                        </p>
                    `;
                    activitiesList.appendChild(activityEl);
                });

                // Attach event listeners to new buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => handleEditActivity(e.target.closest('button').dataset.index));
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => handleDeleteActivity(e.target.closest('button').dataset.index));
                });
            }
        }

        function renderPhotos() {
            photoPreviewsContainer.innerHTML = '';
            photos.forEach((photo, index) => {
                const photoEl = document.createElement('div');
                photoEl.className = 'relative group';
                photoEl.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}" class="photo-thumbnail">
                    <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity delete-photo-btn" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                photoPreviewsContainer.appendChild(photoEl);
            });
            document.querySelectorAll('.delete-photo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    photos.splice(index, 1);
                    renderPhotos();
                    showTemporaryStatus('Foto eliminada temporalmente. Guarde la planificación para confirmar.');
                });
            });
        }

        function handleEditActivity(index) {
            editingIndex = parseInt(index);
            const activity = activities[editingIndex];
            document.getElementById('sector').value = activity.sector;
            document.getElementById('vocero_contacto').value = activity.vocero_contacto;
            document.getElementById('cedula_vocero').value = activity.cedula_vocero;
            document.getElementById('telefono').value = activity.telefono;
            document.getElementById('voceria').value = activity.voceria;
            document.getElementById('actividad').value = activity.actividad;
            document.getElementById('dia').value = activity.dia;
            document.getElementById('fecha').value = activity.fecha;
            document.getElementById('hora').value = activity.hora;
            formTitle.textContent = 'Editar Actividad';
            formButton.textContent = 'Actualizar Actividad';
            showTemporaryStatus('Editando actividad. Modifique los campos y presione "Actualizar".', 'info');
        }

        async function handleDeleteActivity(index) {
            if (!currentUserId) {
                showTemporaryStatus('Error: Por favor, inicie sesión primero.');
                return;
            }
            
            const updatedActivities = [...activities];
            updatedActivities.splice(index, 1);

            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'promotor_schedules', currentUserId);
            try {
                await setDoc(userDocRef, { activities: updatedActivities }, { merge: true });
                showTemporaryStatus('Actividad eliminada.');
            } catch (error) {
                console.error("Error al eliminar la actividad:", error);
                showTemporaryStatus('Error al eliminar la actividad.');
            }
        }


        function resetForm() {
            activityForm.reset();
            formTitle.textContent = 'Nueva Actividad';
            formButton.textContent = 'Agregar Actividad';
            editingIndex = null;
        }

        // --- Eventos del Formulario y Botones ---
        activityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) {
                showTemporaryStatus('Error: Por favor, inicie sesión primero.');
                return;
            }

            const formData = new FormData(activityForm);
            const newActivity = Object.fromEntries(formData.entries());
            
            let updatedActivities = [...activities];
            if (editingIndex !== null) {
                updatedActivities[editingIndex] = newActivity;
            } else {
                updatedActivities.push(newActivity);
            }

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'promotor_schedules', currentUserId);
                await setDoc(userDocRef, { activities: updatedActivities }, { merge: true });
                
                resetForm();
                showTemporaryStatus('Actividad guardada con éxito.');
            } catch (error) {
                console.error("Error al guardar la actividad:", error);
                showTemporaryStatus('Error al guardar la actividad.');
            }
        });

        uploadPhotosBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                showTemporaryStatus('Error: Por favor, inicie sesión primero.', 'error');
                return;
            }
            const date = photoDateInput.value;
            if (!date) {
                showTemporaryStatus('Por favor, seleccione una fecha para las fotos.', 'error');
                return;
            }
            const files = photoUploadInput.files;
            if (files.length === 0) {
                showTemporaryStatus('Por favor, seleccione una o más fotos para subir.', 'error');
                return;
            }

            showTemporaryStatus('Subiendo fotos...', 'info');

            const publicDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'promotor_schedules', currentUserId);
            
            try {
                let docSnap = await getDoc(publicDocRef);
                
                let currentPhotos = docSnap.exists() ? docSnap.data().photos || [] : [];
                let currentActivities = docSnap.exists() ? docSnap.data().activities || [] : [];
                let promotorName = promotorNameInput.value.trim();

                const newPhotos = [...currentPhotos];

                // Convertir cada archivo a Base64
                for (const file of files) {
                    await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            newPhotos.push(e.target.result);
                            resolve();
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // Actualizar o crear el documento con las nuevas fotos
                await setDoc(publicDocRef, {
                    promotorName,
                    activities: currentActivities,
                    photos: newPhotos,
                    lastUpdated: new Date()
                }, { merge: true }); // Usar merge para no sobrescribir actividades

                photoUploadInput.value = ''; // Limpiar el input de archivos
                showTemporaryStatus('Fotos subidas y guardadas con éxito.');
            } catch (error) {
                console.error("Error al subir las fotos:", error);
                showTemporaryStatus('Error al subir las fotos.', 'error');
            }
        });

        saveScheduleBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                showTemporaryStatus('Error: La base de datos no está lista.', 'error');
                return;
            }
            const promotorName = promotorNameInput.value.trim();
            if (promotorName === '') {
                showTemporaryStatus('Por favor, ingrese su nombre de promotor.', 'error');
                return;
            }
            
            const scheduleDate = new Date().toISOString().split('T')[0]; // Usar la fecha actual como ID
            const privateDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'promotor_data', `schedule_${scheduleDate}`);
            const publicDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'promotor_schedules', currentUserId);

            try {
                // Guardar en la colección privada del usuario
                await setDoc(privateDocRef, {
                    promotorName,
                    activities,
                    lastUpdated: new Date()
                });

                // Guardar una copia en la colección pública
                await setDoc(publicDocRef, {
                    promotorName,
                    activities,
                    lastUpdated: new Date()
                });

                showTemporaryStatus('¡Planificación guardada con éxito!');
            } catch (error) {
                console.error("Error al guardar la planificación:", error);
                showTemporaryStatus('Error al guardar la planificación.', 'error');
            }
        });


        // --- Lógica del Jefe de Enlace ---
        async function renderLiaisonView() {
            liaisonList.innerHTML = '<p class="text-center text-gray-400">Cargando datos de promotores...</p>';
            try {
                const publicCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'promotor_schedules');
                const querySnapshot = await getDocs(publicCollectionRef);

                if (querySnapshot.empty) {
                    liaisonList.innerHTML = '<p class="text-center text-gray-400">No hay planificaciones para mostrar.</p>';
                    return;
                }

                liaisonList.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const promotorScheduleEl = document.createElement('div');
                    promotorScheduleEl.className = 'bg-gray-800 p-4 rounded-lg shadow-md border border-gray-600 mb-4';
                    promotorScheduleEl.innerHTML = `
                        <h3 class="text-xl font-bold text-blue-300 mb-2">${data.promotorName}</h3>
                        <p class="text-sm text-gray-500 mb-4">Última actualización: ${data.lastUpdated ? data.lastUpdated.toDate().toLocaleString() : 'N/A'}</p>
                        <div class="space-y-2 mb-4">
                            ${(data.activities || []).map(activity => `
                                <div class="p-3 bg-gray-900 rounded-lg border border-gray-700">
                                    <p class="font-semibold text-gray-300">Sector: ${activity.sector || 'N/A'}</p>
                                    <p class="font-semibold text-gray-300">Actividad: ${activity.actividad || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">Vocero Contacto: ${activity.vocero_contacto || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">Cédula Vocero: ${activity.cedula_vocero || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">Teléfono: ${activity.telefono || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">Vocería: ${activity.voceria || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">Día: ${activity.dia || 'N/A'} | Hora: ${activity.hora || 'N/A'}</p>
                                </div>
                            `).join('')}
                        </div>
                        <h4 class="text-lg font-bold text-gray-300 mb-2">Fotos del Trabajo:</h4>
                        <div class="flex flex-wrap gap-2">
                            ${(data.photos || []).length > 0
                                ? data.photos.map(photoUrl => `<img src="${photoUrl}" alt="Foto de trabajo" class="photo-thumbnail">`).join('')
                                : '<p class="text-gray-400 text-sm">No hay fotos para esta semana.</p>'
                            }
                        </div>
                    `;
                    liaisonList.appendChild(promotorScheduleEl);
                });

            } catch (error) {
                console.error("Error al obtener las planificaciones del Jefe de Enlace:", error);
                liaisonList.innerHTML = '<p class="text-center text-red-400">Error al cargar los datos. Verifique la conexión.</p>';
            }
        }

        showLiaisonViewBtn.addEventListener('click', () => {
            promotorView.classList.add('hidden');
            liaisonView.classList.remove('hidden');
            renderLiaisonView();
        });

        showPromotorViewBtn.addEventListener('click', () => {
            liaisonView.classList.add('hidden');
            promotorView.classList.remove('hidden');
        });

        // --- Lógica del Modal de Información ---
        infoBtn.addEventListener('click', () => {
            infoModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });

        // Cierra el modal si se hace clic fuera de él
        window.addEventListener('click', (event) => {
            if (event.target === infoModal) {
                infoModal.classList.add('hidden');
            }
        });

        // --- Manejador de Autenticación y Carga de Datos ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                if (isSigningUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showTemporaryStatus('Cuenta creada con éxito.');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showTemporaryStatus('Sesión iniciada con éxito.');
                }
            } catch (error) {
                console.error("Error de autenticación:", error);
                showTemporaryStatus(`Error de autenticación: ${error.message}`);
            }
        });

        toggleAuthBtn.addEventListener('click', () => {
            isSigningUp = !isSigningUp;
            if (isSigningUp) {
                authTitle.textContent = 'Crear Cuenta';
                authButton.textContent = 'Crear Cuenta';
                toggleAuthBtn.textContent = '¿Ya tienes una cuenta? Inicia sesión.';
            } else {
                authTitle.textContent = 'Iniciar Sesión';
                authButton.textContent = 'Iniciar Sesión';
                toggleAuthBtn.textContent = '¿No tienes una cuenta? Crea una.';
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showTemporaryStatus('Sesión cerrada con éxito.');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showTemporaryStatus('Error al cerrar sesión.');
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdEl.textContent = user.uid;
                authContainer.classList.add('hidden');
                signOutContainer.classList.remove('hidden');
                promotorDataContainer.classList.remove('hidden');
                isAuthReady = true;

                // Escuchar cambios en la base de datos pública para la vista del promotor
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'promotor_schedules', currentUserId);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        promotorNameInput.value = data.promotorName || '';
                        activities = data.activities || [];
                        photos = data.photos || [];
                        renderActivities();
                        renderPhotos();
                    } else {
                        // Si el documento no existe, inicializar con datos vacíos
                        promotorNameInput.value = '';
                        activities = [];
                        photos = [];
                        renderActivities();
                        renderPhotos();
                    }
                }, (error) => {
                    console.error("Error al obtener los datos en tiempo real:", error);
                });

            } else {
                currentUserId = null;
                userIdEl.textContent = 'No autenticado';
                authContainer.classList.remove('hidden');
                signOutContainer.classList.add('hidden');
                promotorDataContainer.classList.add('hidden');
                isAuthReady = false;
                // Limpiar la UI si el usuario cierra sesión
                promotorNameInput.value = '';
                activities = [];
                photos = [];
                renderActivities();
                renderPhotos();
            }
        });
    </script>
</body>
</html>
